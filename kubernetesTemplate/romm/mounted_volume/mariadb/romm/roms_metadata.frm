TYPE=VIEW
query=select `r`.`id` AS `rom_id`,current_timestamp() AS `created_at`,current_timestamp() AS `updated_at`,coalesce(json_extract(`r`.`igdb_metadata`,\'$.genres\'),json_extract(`r`.`moby_metadata`,\'$.genres\'),json_extract(`r`.`ss_metadata`,\'$.genres\'),json_array()) AS `genres`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.franchises\') then json_extract(`r`.`igdb_metadata`,\'$.franchises\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.franchises\') then json_extract(`r`.`ss_metadata`,\'$.franchises\') else json_array() end AS `franchises`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.collections\') then json_extract(`r`.`igdb_metadata`,\'$.collections\') else json_array() end AS `collections`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.companies\') then json_extract(`r`.`igdb_metadata`,\'$.companies\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.companies\') then json_extract(`r`.`ss_metadata`,\'$.companies\') else json_array() end AS `companies`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.game_modes\') then json_extract(`r`.`igdb_metadata`,\'$.game_modes\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.game_modes\') then json_extract(`r`.`ss_metadata`,\'$.game_modes\') else json_array() end AS `game_modes`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.age_ratings\') and json_length(json_extract(`r`.`igdb_metadata`,\'$.age_ratings\')) > 0 then json_extract(`r`.`igdb_metadata`,\'$.age_ratings[*].rating\') else json_array() end AS `age_ratings`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.first_release_date\') and json_unquote(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\')) regexp \'^[0-9]+$\' then cast(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\') as signed) * 1000 when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.first_release_date\') and json_unquote(json_extract(`r`.`ss_metadata`,\'$.first_release_date\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`r`.`ss_metadata`,\'$.first_release_date\')) regexp \'^[0-9]+$\' then cast(json_extract(`r`.`ss_metadata`,\'$.first_release_date\') as signed) * 1000 else NULL end AS `first_release_date`,case when `r`.`igdb_rating` is not null or `r`.`moby_rating` is not null or `r`.`ss_rating` is not null then (coalesce(`r`.`igdb_rating`,0) + coalesce(`r`.`moby_rating`,0) + coalesce(`r`.`ss_rating`,0)) / (case when `r`.`igdb_rating` is not null then 1 else 0 end + case when `r`.`moby_rating` is not null then 1 else 0 end + case when `r`.`ss_rating` is not null then 1 else 0 end) else NULL end AS `average_rating` from (select `romm`.`roms`.`id` AS `id`,`romm`.`roms`.`igdb_metadata` AS `igdb_metadata`,`romm`.`roms`.`moby_metadata` AS `moby_metadata`,`romm`.`roms`.`ss_metadata` AS `ss_metadata`,case when json_contains_path(`romm`.`roms`.`igdb_metadata`,\'one\',\'$.total_rating\') and json_unquote(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\') as decimal(10,2)) else NULL end AS `igdb_rating`,case when json_contains_path(`romm`.`roms`.`moby_metadata`,\'one\',\'$.moby_score\') and json_unquote(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\') as decimal(10,2)) * 10 else NULL end AS `moby_rating`,case when json_contains_path(`romm`.`roms`.`ss_metadata`,\'one\',\'$.ss_score\') and json_unquote(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\') as decimal(10,2)) * 10 else NULL end AS `ss_rating` from `romm`.`roms`) `r`
md5=b71ff94c5b5f9750d5cd534b08980933
updatable=1
algorithm=0
definer_user=romm
definer_host=%
suid=2
with_check_option=0
timestamp=0001748017179624197
create-version=2
source=SELECT\n                        r.id as rom_id,\n                        NOW() AS created_at,\n                        NOW() AS updated_at,\n                        COALESCE(\n                            JSON_EXTRACT(r.igdb_metadata, \'$.genres\'),\n                            JSON_EXTRACT(r.moby_metadata, \'$.genres\'),\n                            JSON_EXTRACT(r.ss_metadata, \'$.genres\'),\n                            JSON_ARRAY()\n                        ) AS genres,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.franchises\') THEN JSON_EXTRACT(r.igdb_metadata, \'$.franchises\')\n                            WHEN JSON_CONTAINS_PATH(r.ss_metadata, \'one\', \'$.franchises\') THEN JSON_EXTRACT(r.ss_metadata, \'$.franchises\')\n                            ELSE JSON_ARRAY()\n                        END AS franchises,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.collections\') THEN JSON_EXTRACT(r.igdb_metadata, \'$.collections\')\n                            ELSE JSON_ARRAY()\n                        END AS collections,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.companies\') THEN JSON_EXTRACT(r.igdb_metadata, \'$.companies\')\n                            WHEN JSON_CONTAINS_PATH(r.ss_metadata, \'one\', \'$.companies\') THEN JSON_EXTRACT(r.ss_metadata, \'$.companies\')\n                            ELSE JSON_ARRAY()\n                        END AS companies,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.game_modes\') THEN JSON_EXTRACT(r.igdb_metadata, \'$.game_modes\')\n                            WHEN JSON_CONTAINS_PATH(r.ss_metadata, \'one\', \'$.game_modes\') THEN JSON_EXTRACT(r.ss_metadata, \'$.game_modes\')\n                            ELSE JSON_ARRAY()\n                        END AS game_modes,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.age_ratings\')\n                                AND JSON_LENGTH(JSON_EXTRACT(r.igdb_metadata, \'$.age_ratings\')) > 0\n                            THEN\n                                JSON_EXTRACT(r.igdb_metadata, \'$.age_ratings[*].rating\')\n                            ELSE\n                                JSON_ARRAY()\n                        END AS age_ratings,\n\n                        CASE\n                            WHEN JSON_CONTAINS_PATH(r.igdb_metadata, \'one\', \'$.first_release_date\') AND\n                                JSON_UNQUOTE(JSON_EXTRACT(r.igdb_metadata, \'$.first_release_date\')) NOT IN (\'null\', \'None\', \'\') AND\n                                JSON_UNQUOTE(JSON_EXTRACT(r.igdb_metadata, \'$.first_release_date\')) REGEXP \'^[0-9]+$\'\n                            THEN CAST(JSON_EXTRACT(r.igdb_metadata, \'$.first_release_date\') AS SIGNED) * 1000\n\n                            WHEN JSON_CONTAINS_PATH(r.ss_metadata, \'one\', \'$.first_release_date\') AND\n                                JSON_UNQUOTE(JSON_EXTRACT(r.ss_metadata, \'$.first_release_date\')) NOT IN (\'null\', \'None\', \'\') AND\n                                JSON_UNQUOTE(JSON_EXTRACT(r.ss_metadata, \'$.first_release_date\')) REGEXP \'^[0-9]+$\'\n                            THEN CAST(JSON_EXTRACT(r.ss_metadata, \'$.first_release_date\') AS SIGNED) * 1000\n\n                            ELSE NULL\n                        END AS first_release_date,\n\n                        CASE\n                            WHEN (igdb_rating IS NOT NULL OR moby_rating IS NOT NULL OR ss_rating IS NOT NULL) THEN\n                                (COALESCE(igdb_rating, 0) + COALESCE(moby_rating, 0) + COALESCE(ss_rating, 0)) /\n                                (CASE WHEN igdb_rating IS NOT NULL THEN 1 ELSE 0 END +\n                                CASE WHEN moby_rating IS NOT NULL THEN 1 ELSE 0 END +\n                                CASE WHEN ss_rating IS NOT NULL THEN 1 ELSE 0 END)\n                            ELSE NULL\n                        END AS average_rating\n\n                    FROM (\n                        SELECT\n                            id,\n                            igdb_metadata,\n                            moby_metadata,\n                            ss_metadata,\n                            CASE\n                                WHEN JSON_CONTAINS_PATH(igdb_metadata, \'one\', \'$.total_rating\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(igdb_metadata, \'$.total_rating\')) NOT IN (\'null\', \'None\', \'\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(igdb_metadata, \'$.total_rating\')) REGEXP \'^[0-9]+(\\.[0-9]+)?$\'\n                                THEN CAST(JSON_EXTRACT(igdb_metadata, \'$.total_rating\') AS DECIMAL(10,2))\n                                ELSE NULL\n                            END AS igdb_rating,\n                            CASE\n                                WHEN JSON_CONTAINS_PATH(moby_metadata, \'one\', \'$.moby_score\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(moby_metadata, \'$.moby_score\')) NOT IN (\'null\', \'None\', \'\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(moby_metadata, \'$.moby_score\')) REGEXP \'^[0-9]+(\\.[0-9]+)?$\'\n                                THEN CAST(JSON_EXTRACT(moby_metadata, \'$.moby_score\') AS DECIMAL(10,2)) * 10\n                                ELSE NULL\n                            END AS moby_rating,\n                            CASE\n                                WHEN JSON_CONTAINS_PATH(ss_metadata, \'one\', \'$.ss_score\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(ss_metadata, \'$.ss_score\')) NOT IN (\'null\', \'None\', \'\') AND\n                                    JSON_UNQUOTE(JSON_EXTRACT(ss_metadata, \'$.ss_score\')) REGEXP \'^[0-9]+(\\.[0-9]+)?$\'\n                                THEN CAST(JSON_EXTRACT(ss_metadata, \'$.ss_score\') AS DECIMAL(10,2)) * 10\n                                ELSE NULL\n                            END AS ss_rating\n                        FROM roms\n                    ) AS r
client_cs_name=utf8mb4
connection_cl_name=utf8mb4_uca1400_ai_ci
view_body_utf8=select `r`.`id` AS `rom_id`,current_timestamp() AS `created_at`,current_timestamp() AS `updated_at`,coalesce(json_extract(`r`.`igdb_metadata`,\'$.genres\'),json_extract(`r`.`moby_metadata`,\'$.genres\'),json_extract(`r`.`ss_metadata`,\'$.genres\'),json_array()) AS `genres`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.franchises\') then json_extract(`r`.`igdb_metadata`,\'$.franchises\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.franchises\') then json_extract(`r`.`ss_metadata`,\'$.franchises\') else json_array() end AS `franchises`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.collections\') then json_extract(`r`.`igdb_metadata`,\'$.collections\') else json_array() end AS `collections`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.companies\') then json_extract(`r`.`igdb_metadata`,\'$.companies\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.companies\') then json_extract(`r`.`ss_metadata`,\'$.companies\') else json_array() end AS `companies`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.game_modes\') then json_extract(`r`.`igdb_metadata`,\'$.game_modes\') when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.game_modes\') then json_extract(`r`.`ss_metadata`,\'$.game_modes\') else json_array() end AS `game_modes`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.age_ratings\') and json_length(json_extract(`r`.`igdb_metadata`,\'$.age_ratings\')) > 0 then json_extract(`r`.`igdb_metadata`,\'$.age_ratings[*].rating\') else json_array() end AS `age_ratings`,case when json_contains_path(`r`.`igdb_metadata`,\'one\',\'$.first_release_date\') and json_unquote(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\')) regexp \'^[0-9]+$\' then cast(json_extract(`r`.`igdb_metadata`,\'$.first_release_date\') as signed) * 1000 when json_contains_path(`r`.`ss_metadata`,\'one\',\'$.first_release_date\') and json_unquote(json_extract(`r`.`ss_metadata`,\'$.first_release_date\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`r`.`ss_metadata`,\'$.first_release_date\')) regexp \'^[0-9]+$\' then cast(json_extract(`r`.`ss_metadata`,\'$.first_release_date\') as signed) * 1000 else NULL end AS `first_release_date`,case when `r`.`igdb_rating` is not null or `r`.`moby_rating` is not null or `r`.`ss_rating` is not null then (coalesce(`r`.`igdb_rating`,0) + coalesce(`r`.`moby_rating`,0) + coalesce(`r`.`ss_rating`,0)) / (case when `r`.`igdb_rating` is not null then 1 else 0 end + case when `r`.`moby_rating` is not null then 1 else 0 end + case when `r`.`ss_rating` is not null then 1 else 0 end) else NULL end AS `average_rating` from (select `romm`.`roms`.`id` AS `id`,`romm`.`roms`.`igdb_metadata` AS `igdb_metadata`,`romm`.`roms`.`moby_metadata` AS `moby_metadata`,`romm`.`roms`.`ss_metadata` AS `ss_metadata`,case when json_contains_path(`romm`.`roms`.`igdb_metadata`,\'one\',\'$.total_rating\') and json_unquote(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`igdb_metadata`,\'$.total_rating\') as decimal(10,2)) else NULL end AS `igdb_rating`,case when json_contains_path(`romm`.`roms`.`moby_metadata`,\'one\',\'$.moby_score\') and json_unquote(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`moby_metadata`,\'$.moby_score\') as decimal(10,2)) * 10 else NULL end AS `moby_rating`,case when json_contains_path(`romm`.`roms`.`ss_metadata`,\'one\',\'$.ss_score\') and json_unquote(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\')) not in (\'null\',\'None\',\'\') and json_unquote(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\')) regexp \'^[0-9]+(.[0-9]+)?$\' then cast(json_extract(`romm`.`roms`.`ss_metadata`,\'$.ss_score\') as decimal(10,2)) * 10 else NULL end AS `ss_rating` from `romm`.`roms`) `r`
mariadb-version=110702
